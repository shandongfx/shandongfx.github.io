<!DOCTYPE html>
	<html>
		<head>
			<title>Ecological niche modelling in R - part 1</title>
			<!-- link to main stylesheet -->
			<link rel="stylesheet" type="text/css" href="/css/main.css">
		</head>
		<body>
			<nav>
	    		<ul>
	        		<li><a href="/">Home</a></li>
					<li><a href="/publication">Publication</a></li>
	        		<li><a href="/blog/">Research note</a></li>
					<li><a href="/teaching/">Teaching</a></li>
					

	    		</ul>
			</nav>
			<div class="container">
			
			<p>There are severl ENM/SDM packages in literature, but <a href="https://cran.r-project.org/web/packages/dismo/index.html">dismo</a> is the very first and very useful package that include a lot of basic functions in ENM. Other packages may help you automatically do a lot works, but dismo is the one that help you understand what is going on underneath process of data manupulation &amp; niche modeling. Personally, I think dismo is a great tool for methodological studies if your study involves parameter manipulations or a lot of repeated workflows (e.g. a lot of species).</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># Load dismo library
</span><span class="n">library</span><span class="p">(</span><span class="n">dismo</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## Loading required package: methods
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## Loading required package: raster
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## Loading required package: sp
</code></pre>
</div>

<h1 id="occurrences">1. occurrences</h1>

<h2 id="load-occurrences">1.1 Load occurrences</h2>
<p>Typically, there are two ways to get occurrences: 1) load a local csv file into R; 2) download observations from online databases, e.g. <a href="http://gbif.org">GBIF</a> . There is a <em>gbif()</em> function can help automatically download species’ occurrences without clicking or searching on GBIF website. The parameters provided by <em>gbif()</em> give you a lot flexibilities. See this simple example below.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1">#simply type in the species' scientific name
</span><span class="w"> </span><span class="n">occ</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gbif</span><span class="p">(</span><span class="s2">"Dasypus novemcinctus"</span><span class="p">)</span><span class="w">
 </span><span class="n">write.csv</span><span class="p">(</span><span class="n">occ</span><span class="p">,</span><span class="s2">"d:/temp/Dasypus_novemcinctus.csv"</span><span class="p">)</span><span class="w">
</span><span class="c1">#read.csv("d:/temp/Dasypus_novemcinctus.csv")
</span></code></pre>
</div>

<p>You may also automatically go over a list of species you are interested.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">species_list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Dasypus kappleri"</span><span class="p">,</span><span class="w">
                  </span><span class="s2">"Dasypus hybridus"</span><span class="p">,</span><span class="w">
                  </span><span class="s2">"Dasypus novemcinctus"</span><span class="p">)</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">species_list</span><span class="p">)){</span><span class="w">
   </span><span class="n">occ</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gbif</span><span class="p">(</span><span class="w"> </span><span class="n">species_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="c1"># download i-th species and save data
</span><span class="w">   </span><span class="n">write.csv</span><span class="p">(</span><span class="n">occ</span><span class="p">,</span><span class="n">paste</span><span class="p">(</span><span class="s2">"d:/temp/"</span><span class="p">,</span><span class="n">species_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s2">".csv"</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s2">""</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>Most commonly, we load a csv file from local disk.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">occ</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"d:/temp/Dasypus_novemcinctus.csv"</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<h2 id="manipulate-occurrences">1.2 Manipulate occurrences</h2>
<p>We always need to clean the occurrences. Here I showed a few functions frequently used for my work.</p>

<p>Example of removing duplicated records according to the columns of lon &amp; lat.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># check duplicates
</span><span class="n">dup_results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">duplicated</span><span class="p">(</span><span class="n">occ</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s2">"lon"</span><span class="p">,</span><span class="s2">"lat"</span><span class="p">)])</span><span class="w">
</span><span class="n">table</span><span class="p">(</span><span class="n">dup_results</span><span class="p">)</span><span class="w">  </span><span class="c1"># TRUE: not unique record, FALSE: unique record
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## dup_results
## FALSE  TRUE 
##  1733  2630
</code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">nrow</span><span class="p">(</span><span class="n">occ</span><span class="p">)</span><span class="w">  </span><span class="c1"># original records number
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] 4363
</code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">occ_unique</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">occ</span><span class="p">[</span><span class="o">!</span><span class="n">dup_results</span><span class="p">,]</span><span class="w">
</span><span class="n">nrow</span><span class="p">(</span><span class="n">occ_unique</span><span class="p">)</span><span class="w">  </span><span class="c1"># updated records number
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] 1733
</code></pre>
</div>

<p>Example of subseting records by attributes (column).</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># remove NA values 
</span><span class="n">occ_updated</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">occ_unique</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">lon</span><span class="p">))</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w">

</span><span class="c1"># select by year
</span><span class="n">occ_selected</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">occ_unique</span><span class="p">,</span><span class="n">year</span><span class="o">==</span><span class="m">2016</span><span class="p">)</span><span class="w">  </span><span class="c1"># select records in 2016
</span><span class="w">
</span><span class="n">occ_selected</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">occ_unique</span><span class="p">,</span><span class="n">year</span><span class="o">&gt;=</span><span class="m">1950</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">&lt;=</span><span class="m">2000</span><span class="p">)</span><span class="w">  </span><span class="c1"># between 1950~2000
</span><span class="w">
</span><span class="n">occ_selected</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">occ_unique</span><span class="p">,</span><span class="n">year</span><span class="o">&lt;</span><span class="m">1950</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">&gt;</span><span class="m">2000</span><span class="p">)</span><span class="w">  </span><span class="c1"># before 1950 or after 2000
</span><span class="w">
</span><span class="n">occ_selected</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">occ_unique</span><span class="p">,</span><span class="n">year</span><span class="o">&gt;=</span><span class="m">1950</span><span class="w">  </span><span class="c1"># a combination of more conditions
</span><span class="w">                       </span><span class="o">&amp;</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">&lt;=</span><span class="m">2000</span><span class="w"> 
                       </span><span class="o">&amp;</span><span class="w"> </span><span class="n">lat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<h2 id="make-occurrences-spatial">1.3 Make occurrences spatial!</h2>
<p>Pay attention to the grammar.<br />
(1) Use <strong>&lt;- ~</strong>, not <strong>&lt;-</strong>.<br />
(2) “lon” and “lat” are column names from the data.frame.<br />
(3) make sure x/longitude first.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">coordinates</span><span class="p">(</span><span class="w"> </span><span class="n">occ_updated</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lat</span><span class="w">
</span><span class="nf">class</span><span class="p">(</span><span class="n">occ_updated</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] "SpatialPointsDataFrame"
## attr(,"package")
## [1] "sp"
</code></pre>
</div>

<p>With R, we can easily transform spatial data into shape files, which may be used in ArcGIS or QGIS for plotting purpose.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">shapefile</span><span class="p">(</span><span class="n">occ_updated</span><span class="p">,</span><span class="s2">"d:/temp/occ.shp"</span><span class="p">)</span><span class="w">
</span><span class="n">occ_updated</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">shapefile</span><span class="p">(</span><span class="s2">"d:/temp/occ.shp"</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<h1 id="raster-files">2. Raster files</h1>
<p>I used worldclim dataset as an example. Please refer to my  <a href="http://lab.fengxiao.info/2015/10/25/GIS-in-R-workshop.html"><strong>GIS Tutorial</strong></a> for more examples of raster analysis in R.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># load two layers: annual T. &amp; P.
</span><span class="n">basemap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stack</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"d:/Xiao/GISDATA/climate/WC/WorldClim_10arcmin_bil/bio1.bil"</span><span class="p">),</span><span class="w">
                 </span><span class="s2">"d:/Xiao/GISDATA/climate/WC/WorldClim_10arcmin_bil/bio12.bil"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Extract the raster to North &amp; South America
</span><span class="n">extent</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-180</span><span class="p">,</span><span class="m">-30</span><span class="p">,</span><span class="m">-60</span><span class="p">,</span><span class="m">80</span><span class="p">)</span><span class="w">
</span><span class="n">basemap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">crop</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span><span class="n">extent</span><span class="p">)</span><span class="w"> 
</span><span class="n">plot</span><span class="p">(</span><span class="n">basemap</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<p><img src="/figure/source/2016-11-23-ENM-in-R-workshop/unnamed-chunk-10-1.png" alt="plot of chunk unnamed-chunk-10" /></p>

<p>Plot occurrences on the base map.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># It is always good to unify the coordinate reference system (CRS). There is a good document about CRS 
# https://www.nceas.ucsb.edu/~frazier/RSpatialGuides/OverviewCoordinateReferenceSystems.pdf
</span><span class="n">crs</span><span class="p">(</span><span class="n">occ_updated</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">crs</span><span class="p">(</span><span class="n">basemap</span><span class="p">)</span><span class="w">  </span><span class="c1"># Here I directly assign WGS84 to occurrences; but if you have different CRS, you need to transform one to the other.
</span><span class="n">plot</span><span class="p">(</span><span class="n">basemap</span><span class="p">[[</span><span class="m">1</span><span class="p">]])</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">occ_updated</span><span class="p">,</span><span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<p><img src="/figure/source/2016-11-23-ENM-in-R-workshop/unnamed-chunk-11-1.png" alt="plot of chunk unnamed-chunk-11" /></p>

<p>It seems some points are not located on the landmass, which should have NA values. Let’s remove them.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">extracted</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">extract</span><span class="p">(</span><span class="n">basemap</span><span class="p">[[</span><span class="m">1</span><span class="p">]],</span><span class="n">occ_updated</span><span class="p">)</span><span class="w">
</span><span class="n">table</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">extracted</span><span class="p">))</span><span class="w">  </span><span class="c1"># There are a few points have NA values
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## 
## FALSE  TRUE 
##  1729     3
</code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">occ_updated</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">occ_updated</span><span class="p">[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">extracted</span><span class="p">),</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">basemap</span><span class="p">[[</span><span class="m">1</span><span class="p">]])</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">occ_updated</span><span class="p">,</span><span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span><span class="w">  </span><span class="c1"># Yes, they disappeared.
</span></code></pre>
</div>

<p><img src="/figure/source/2016-11-23-ENM-in-R-workshop/unnamed-chunk-12-1.png" alt="plot of chunk unnamed-chunk-12" /></p>

<h1 id="train-models-in-r">3. Train models in R</h1>
<h2 id="maxent">3.1 Maxent</h2>
<p>The following 3 conditions are important for running maxent in R.<br />
(1) Install <strong>rJava</strong> package.<br />
(2) I suggest use 32-bit R, because I assume there is an issue of rJava for 64-bit R. <br />
(3) Also, we must download and copy the maxent.jar into a special folder, typically it is the <em>java</em> folder under <em>dismo</em> folder. In my case, it is:
<strong>D:/Program Files/R/R-3.3.1/library/dismo/java/maxent.jar</strong></p>

<p>There are two ways to run Maxent. One way is similar as the method when we run the interface of maxent, we need occurrence points and rasters; the other way is provide a data.frame with environmental conditions for presences and pseudo-absences.</p>

<p>Example of the 1st method. Different from the maxent interface, training model, projecting model, and evaluating model are typically independent steps.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># training model
</span><span class="n">myModel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">maxent</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">basemap</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">occ_updated</span><span class="p">)</span><span class="w">

</span><span class="c1"># projecting model 
</span><span class="n">prediction_now</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="w"> </span><span class="p">(</span><span class="n">myModel</span><span class="p">,</span><span class="w"> </span><span class="n">basemap</span><span class="p">)</span><span class="w">

</span><span class="c1"># make future temperature warmer &amp; wetter
</span><span class="n">futuremap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">basemap</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">100</span><span class="w">
</span><span class="n">prediction_future</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="w"> </span><span class="p">(</span><span class="n">myModel</span><span class="p">,</span><span class="w"> </span><span class="n">futuremap</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">stack</span><span class="p">(</span><span class="n">prediction_now</span><span class="p">,</span><span class="n">prediction_future</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>

<p><img src="/figure/source/2016-11-23-ENM-in-R-workshop/unnamed-chunk-13-1.png" alt="plot of chunk unnamed-chunk-13" /></p>

<h1 id="more-examples-to-be-added">More examples to be added:</h1>
<ul>
  <li>seperate occurrences into training and testing</li>
  <li>manipulate training area</li>
  <li>run maxent with data.frame</li>
  <li>manipulate maxent parameters, e.g. beta, features, clamping, output folder</li>
</ul>

<h1 id="references">References:</h1>
<ul>
  <li>Robert J. Hijmans and Jane Elith (2016) Species distribution modeling with R https://cran.r-project.org/web/packages/dismo/vignettes/sdm.pdf</li>
</ul>

			
			</div><!-- /.container -->
			<footer>
<h5> Copyright 2015-2016 by Xiao Feng </h5>
			</footer>
			<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86239714-1', 'auto');
  ga('send', 'pageview');

</script>

		</body>
	</html>
